--- bin/Castalia	2011-02-21 21:50:01.000000000 -0800
+++ bin/Castalia	2015-08-16 02:02:41.487469000 -0700
@@ -11,22 +11,63 @@
 # *                                                                          *
 # ***************************************************************************/
 
-import os, sys, commands, getopt, re
+import os, sys, commands, getopt, re, platform
 from datetime import date, time, datetime
 from optparse import OptionParser
 
+if platform.system() == "Windows":
+	castaliaBinExtension = ".exe"
+	deleteFileCommand = "del"
+else:
+	castaliaBinExtension = ""
+	deleteFileCommand = "rm"
+	
 #initialise important paths
 pathToBin = sys.path[0]
 pathToCastalia = os.path.abspath(pathToBin + "/../")
-pathToCastaliaBin = pathToCastalia + "/CastaliaBin";
+pathToCastaliaBin = pathToCastalia + "/CastaliaBin" + castaliaBinExtension;
 pathToExtract = pathToBin + "/extractOmnetppINI"
 
+def read_file(name,hasGeneral = 0):
+	if (not os.path.exists(name) or not os.path.isfile(name)):
+		quit("ERROR: no such file " + name)
+	
+	f = open(name,"r")
+	lines = f.readlines()
+	f.close()
+	newLines = ""
+	
+	for line in lines:
+		line = line.strip()
+		if (line == "[General]"): 
+			if (hasGeneral): continue
+			hasGeneral = 1
+		if (len(line) == 0 or line[0] == '#'): continue
+		pos = line.find('#')
+		if (pos != -1): 
+			line = line[:pos].strip()
+		if (line.find("include") == 0):
+			file = line[8:]
+			newLines = newLines + read_file(file, hasGeneral)
+		else: newLines = newLines + line + '\n'
+	
+	return newLines
+	
+def extractOmnetppINI(file):  
+	if (os.path.dirname(file) != ''):
+		os.chdir(os.path.dirname(file))
+		file = os.path.basename(file)     
+	
+	text = read_file(file)
+	pos = len(text) - 1
+	return text[:pos]
+
 if len(sys.argv) == 1:
 	has_header = 0
 	for file in os.listdir('./'):
 		if not os.path.isfile(file): continue
 		if not re.search(r"\.ini$",file): continue
-		lines = commands.getoutput(pathToExtract + " " + file).split("\n")
+		lines = extractOmnetppINI(file).split("\n")
 		if len(lines) < 2: continue
 		has_general = 0;
 		list = []
@@ -295,11 +336,13 @@
 	f = open("omnetpp.tmp","w")
 	f.write("[General]\n")
 	f.write("repeat = " + str(options.repeat) + "\n")
+	f.write("SN.generateResultsFile = true \n") #allows compatibility with OMNeT++ IDE
+	f.write("SN.traceType = \"file\" \n") #allows compatibility with OMNeT++ IDE
 	for k in sorted(ini.keys()):
 		f.write(k + " = " + ini[k] + "\n")
 	f.close();
 	has_result = 0
-	result = commands.getoutput(pathToCastaliaBin + " -f omnetpp.tmp");
+	result = os.popen(pathToCastaliaBin + " -f omnetpp.tmp", 'r').read() # using popen instead of commands.getoutput, which does not work on Windows.
 	if options.debug: print result
 	raw_result = []
 	for line in result.split("\n"):
@@ -321,5 +364,7 @@
 			raw_result.append(line)
 	if not has_result: fr.write("\n".join(raw_result))
 
-if not options.debug: commands.getoutput("rm omnetpp.tmp")
-fr.close()
+if not options.debug: 
+	os.popen(deleteFileCommand + " omnetpp.tmp", 'r').read() # using popen instead of commands.getoutput, which does not work on Windows.
+
+fr.close()